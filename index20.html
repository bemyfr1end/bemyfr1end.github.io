<html>
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JS AI Body Tracker v1.0.0</title>
	<link href="data:image/x-icon;base64,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"
          rel="icon" type="image/x-icon"/>
    <meta name="description"
          content="JS AI Body Tracker - javascript library implementing body tracking with ANN models: MoveNet, PoseNet and Blase Pose"/>
    <meta name="robots" content="index, follow"/>
    <meta name="og:site_name" content="JS AI Body Tracker"/>
    <meta name="og:type" content="website"/>
    <meta name="og:title" content="JS AI Body Tracker"/>
    <meta name="og:description"
          content="JS AI Body Tracker - javascript library implementing body tracking with ANN models: MoveNet, PoseNet and Blase Pose"/>
    <meta name="og:url" content="https://szczyglis.dev/js-ai-body-tracker"/>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
	<link rel="stylesheet" href="/css/style2.css">	
	<link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.0.0/video-js.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.0.0/video.min.js"></script>
</head>

<body>
	<div id="controls">
		<form method="GET">
			<div class="container">
				
			</div>
		</form>	

		<button id="btn_toggle_ai" class="btn btn-secondary">AI TRACKING ON/OFF</button>
		<button id="btn_toggle_video" class="btn btn-secondary">VIDEO ON/OFF</button>			
		<button id="btn_toggle_3d" class="btn btn-secondary">3D VIEW ON/OFF</button>
		<button id="btn_toggle_debug" class="btn btn-secondary">DEBUG ON/OFF</button>

		<div id="video_src_area" style="display:none" class="text-center mt-3">
			<div class="container justify-content-center">
				<form class="form-horizontal" onsubmit="return false;">
					<div class="form-row justify-content-center">
					  	<div class="col-10 text-right">
					  		<div class="input-group mb-2">
						        <div class="input-group-prepend">
						          <div class="input-group-text">
						          	<span id="video_src_prefix"></span>
						          </div>
						      	</div>
					     	<input class="form-control" id="video_src" type="text" value="">
					     	</div>
					     </div>	
					     <div class="col-auto">
					      	<button id="btn_load_src" class="btn btn-primary">LOAD</button>
					     </div>	
					</div>
				</form>	
			</div>
			<div class="mt-2 text-center">
				<b>Tip:</b> click on "PLAY" icon to play or change video source URL and click "LOAD" button.
			</div>
		</div>
	</div>
	<button id="btn_toggle_controls" class="btn btn-primary">SHOW/HIDE CONTROLS</button>

	<div class="mt-2 text-center" id="status"></div>

	<div id="wrapper" class="container-fluid">		
	  <canvas id="canvas"></canvas>&nbsp;&nbsp;&nbsp;<canvas id="vidcanvas"></canvas>
	  <video id="video" class="video-js vjs-fluid vjs-default-skin" preload="metadata">
	  	<source src="">
	  </video>
	  <div id="info_debug"></div>
	  <div id="info_counter"></div>
	</div>
	<div id="view_3d"></div>
	<!-- Load Tensor Flow -->
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

	<!-- Load tracker.js and app.js-->
	<script src="/js/app2.js"></script>
	<script src="/js/tracker2.js"></script>
	<script>

		let source = 'camera'; // camera|video|stream		
		let sourceVideo = '';
		let defaultVideo = '/videos/1.mp4';
		let model = 'MoveNetSinglePoseLightning';
		/*
			^^^ available pre-defined models:
				
				- MoveNetSinglePoseLightning				
				- MoveNetSinglePoseThunder
				- MoveNetMultiPoseLightning
				- PoseNetMobileNetV1
				- PoseNetResNet50
				- BlazePoseLite
				- BlazePoseHeavy
				- BlazePoseFull
		 */

		// initialize app
		app.init();
		
		// initialize AI tracker model
		tracker.setModel(model);
		tracker.autofit = true; // enable auto resize/fit

		// set-up hooks
		tracker.on('statuschange', function(msg) {
			app.updateStatus(msg);
        });
		tracker.on('beforeupdate', function(poses) {
			app.updateDebug(poses);
			app.updateCounter(poses);
		});

		// config		
	    tracker.elCanvas = '#canvas';
	    tracker.elVideo = '#video';
	    tracker.el3D = '#view_3d';
	    tracker.pointWidth = 6;
    	tracker.pointRadius = 8;

		// run predictions
		tracker.run(source);

        function playStream(canvas, stream) {
        var video = document.createElement('video');
        video.addEventListener('loadedmetadata', function() {
        const context = canvas.getContext('2d');
        var drawFrame = function() {
        context.drawImage(video, 0, 0);
        window.requestAnimationFrame(drawFrame);
        };
        drawFrame();
        });
        video.autoplay = true;
        video.srcObject = stream;
        }
        
        function playCamera(canvas, preferedWidth, preferedHeight) {
        var devices = navigator.mediaDevices;
        if (devices && 'getUserMedia' in devices) {
        var constraints = {
        video: {
        width: preferedWidth,
        height: preferedHeight
        }
        };
        var promise = devices.getUserMedia(constraints);
        promise
        .then(function(stream) {
        playStream(canvas, stream);
        })
        .catch(function(error) {
        console.error(error.name + ': ' + error.message);
        });
        } else {
        console.error('Camera API is not supported.');
        }
        }
        
        
        // Usage example:
        
        var canvas = document.querySelector('#vidcanvas');
        
        playCamera(canvas, canvas.width, canvas.height);
        
        var mediaSource = "/videos/9.mp4";
        
        var muted = true;
        var canvas = document.getElementById("myCanvas"); // get the canvas from the page
        var ctx = canvas.getContext("2d");
        var videoContainer; // object to hold video and associated info
        var video = document.createElement("video"); // create a video element
        video.src = mediaSource;
        // the video will now begin to load.
        // As some additional info is needed we will place the video in a
        // containing object for convenience
        video.autoPlay = false; // ensure that the video does not auto play
        video.loop = false; // set the video to loop.
        video.sound = 10;
        videoContainer = {  // we will add properties as needed
        video : video,
        ready : false,   
        };
        // To handle errors. This is not part of the example at the moment. Just fixing for Edge that did not like the ogv format video
        video.onerror = function(e){
        document.body.removeChild(canvas);
        document.body.innerHTML += "<h2>There is a problem loading the video</h2><br>";
        document.body.innerHTML += "Users of IE9+ , the browser does not support WebM videos used by this demo";
        document.body.innerHTML += "<br><a href='https://tools.google.com/dlpage/webmmf/'> Download IE9+ WebM support</a> from tools.google.com<br> this includes Edge and Windows 10";
        
        }
        video.oncanplay = readyToPlayVideo; // set the event to the play function that 
        // can be found below
        function readyToPlayVideo(event){ // this is a referance to the video
        // the video may not match the canvas size so find a scale to fit
        videoContainer.scale = Math.min(
        canvas.width / this.videoWidth, 
        canvas.height / this.videoHeight); 
        videoContainer.ready = true;
        // the video can be played so hand it off to the display function
        requestAnimationFrame(updateCanvas);
        // add instruction
        
        
        }
        
        function updateCanvas(){
        ctx.clearRect(0,0,canvas.width,canvas.height); 
        // only draw if loaded and ready
        if(videoContainer !== undefined && videoContainer.ready){ 
        // find the top left of the video on the canvas
        // video.muted = muted;
        var scale = videoContainer.scale;
        var vidH = videoContainer.video.videoHeight;
        var vidW = videoContainer.video.videoWidth;
        var top = canvas.height / 2 - (vidH /2 ) * scale;
        var left = canvas.width / 2 - (vidW /2 ) * scale;
        // now just draw the video the correct size
        ctx.drawImage(videoContainer.video, left, top, vidW * scale, vidH * scale);
        if(videoContainer.video.paused){ // if not playing show the paused screen 
        drawPayIcon();
        }
        }
        // all done for display 
        // request the next frame in 1/60th of a second
        requestAnimationFrame(updateCanvas);
        }
        
        function drawPayIcon(){
        ctx.fillStyle = "black";  // darken display
        ctx.globalAlpha = 0.5;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "#DDD"; // colour of play icon
        ctx.globalAlpha = 0.75; // partly transparent
        ctx.beginPath(); // create the path for the icon
        var size = (canvas.height / 2) * 0.5;  // the size of the icon
        ctx.moveTo(canvas.width/2 + size/2, canvas.height / 2); // start at the pointy end
        ctx.lineTo(canvas.width/2 - size/2, canvas.height / 2 + size);
        ctx.lineTo(canvas.width/2 - size/2, canvas.height / 2 - size);
        ctx.closePath();
        ctx.fill();
        ctx.globalAlpha = 1; // restore alpha
        }    
        
        function playPauseClick(){
        if(videoContainer !== undefined && videoContainer.ready){
        if(videoContainer.video.paused){                                 
        videoContainer.video.play();
        }else{
        videoContainer.video.pause();
        }
        }
        }
        
        // register the event
        canvas.addEventListener("click",playPauseClick);
        </script>
</body>
</html>
